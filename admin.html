<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Lapas</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* TABS */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; gap: 5px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 4px solid transparent; white-space: nowrap; transition: 0.3s; }
        .tab-btn:hover, .tab-btn.active { color: #8B0000; border-bottom-color: #8B0000; background: #fdfdfd; }
        
        /* TABLES */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; vertical-align: middle; }
        th { background: #8B0000; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        
        /* CONTROLS */
        .filter-bar { background: #fff3cd; padding: 15px; border-radius: 8px; display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        .print-area { background: #e3f2fd; padding: 15px; border-radius: 8px; display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; height: 38px; }
        .btn-search { background: #8B0000; }
        .btn-print { background: #007bff; }
        .btn-reset { background: #555; }
        
        /* STATUS & ACTION */
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 10px; text-transform: uppercase; }
        .bg-wait { background: #6c757d; } .bg-acc { background: #28a745; } .bg-rej { background: #dc3545; }
        .act-btn { width: 30px; height: 30px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 2px; }
        
        /* MODAL */
        #imgModal, #galleryModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 90%; max-height: 90vh; border-radius: 8px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 8px; }
        .gallery-item { display: flex; flex-direction: column; align-items: center; }
        .gallery-item img { width: 100%; height: 120px; object-fit: cover; border: 1px solid #ddd; cursor: pointer; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }

        input, textarea, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #login-box { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="login-box">
    <h2 style="color:#8B0000;">ADMIN LOGIN</h2>
    <input id="email" type="email" placeholder="Email" style="margin-bottom:10px;">
    <input id="pass" type="password" placeholder="Password" style="margin-bottom:10px;">
    <button onclick="login()" class="btn btn-search" style="width:100%;">MASUK</button>
</div>

<div id="imgModal">
    <span class="close-modal" onclick="closeM('imgModal')">&times;</span>
    <img id="imgView" class="modal-content">
</div>

<div id="galleryModal">
    <span class="close-modal" onclick="closeM('galleryModal')">&times;</span>
    <div id="galleryGrid" class="gallery-grid"></div>
</div>

<div id="panel-box" class="container" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:#8B0000; margin:0;">Dashboard Admin Lapas</h2>
        <button onclick="logout()" class="btn btn-reset">LOGOUT</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="tab('set')" id="b1">‚öôÔ∏è PENGATURAN</button>
        <button class="tab-btn" onclick="tab('fisik')" id="b2">üì• TATAP MUKA</button>
        <button class="tab-btn" onclick="tab('online')" id="b3">üíª VIDEO CALL</button>
        <button class="tab-btn" onclick="tab('urus')" id="b4">üìÇ PENGURUSAN</button>
        <button class="tab-btn" onclick="tab('kritik')" id="b5">üì¢ KRITIK SARAN</button>
    </div>

    <div id="t-set">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h3>Identitas & Kop Surat</h3>
                <input id="app_name" placeholder="Nama Aplikasi"><br><br>
                <input id="kop_1" placeholder="Baris 1 (Kementerian)">
                <input id="kop_2" placeholder="Baris 2 (Wilayah)">
                <input id="kop_3" placeholder="Baris 3 (Nama UPT)">
                <input id="kop_4" placeholder="Baris 4 (Alamat)">
            </div>
            <div>
                <h3>Konten & Syarat</h3>
                <textarea id="announcement" placeholder="Pengumuman (Info Penting)"></textarea>
                <textarea id="txt_doc" placeholder="Syarat Dokumen" style="margin-top:5px;"></textarea>
                <textarea id="txt_item" placeholder="Aturan Barang" style="margin-top:5px;"></textarea>
            </div>
        </div>
        <button onclick="saveConf()" class="btn btn-acc" style="width:100%; margin-top:20px; height:50px;">üíæ SIMPAN SEMUA PENGATURAN</button>
    </div>

    <div id="t-fisik" style="display:none;">
        <div class="filter-bar">
            <div><label>Tanggal:</label><input type="date" id="d_fisik"></div>
            <button onclick="load('registrations','tb_fisik','d_fisik')" class="btn btn-search">CARI</button>
            <button onclick="live('registrations','tb_fisik')" class="btn btn-reset">LIVE</button>
        </div>
        <div class="print-area">
            <input id="p_nm_fisik" placeholder="Nama Petugas">
            <input id="p_nip_fisik" placeholder="NIP Petugas">
            <button onclick="pdf('tb_fisik','Laporan Kunjungan Tatap Muka','p_nm_fisik','p_nip_fisik')" class="btn btn-print">CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_fisik">
                <thead><tr><th>No</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_fisik"></tbody>
            </table>
        </div>
    </div>

    <div id="t-online" style="display:none;">
        <div class="filter-bar">
            <div><label>Tanggal:</label><input type="date" id="d_online"></div>
            <button onclick="load('online_registrations','tb_online','d_online')" class="btn btn-search">CARI</button>
            <button onclick="live('online_registrations','tb_online')" class="btn btn-reset">LIVE</button>
        </div>
        <div class="print-area">
            <input id="p_nm_online" placeholder="Nama Petugas">
            <input id="p_nip_online" placeholder="NIP Petugas">
            <button onclick="pdf('tb_online','Laporan Video Call','p_nm_online','p_nip_online')" class="btn btn-print">CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_online">
                <thead><tr><th>No</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_online"></tbody>
            </table>
        </div>
    </div>

    <div id="t-urus" style="display:none;">
        <div class="filter-bar">
            <div><label>Tanggal:</label><input type="date" id="d_urus"></div>
            <button onclick="load('pengurusan','tb_urus','d_urus')" class="btn btn-search">CARI</button>
            <button onclick="live('pengurusan','tb_urus')" class="btn btn-reset">LIVE</button>
        </div>
        <div class="print-area">
            <input id="p_nm_urus" placeholder="Nama Petugas">
            <input id="p_nip_urus" placeholder="NIP Petugas">
            <button onclick="pdf('tb_urus','Laporan Pengurusan PB/CB/CMB','p_nm_urus','p_nip_urus')" class="btn btn-print">CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_urus">
                <thead><tr><th>Tanggal</th><th>WBP</th><th>Penjamin</th><th>Hubungan</th><th>Berkas</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_urus"></tbody>
            </table>
        </div>
    </div>

    <div id="t-kritik" style="display:none;">
        <div class="filter-bar">
            <button onclick="live('kritik_saran','tb_kritik')" class="btn btn-reset">MUAT DATA TERBARU</button>
        </div>
        <div class="print-area">
            <input id="p_nm_kritik" placeholder="Nama Petugas">
            <input id="p_nip_kritik" placeholder="NIP Petugas">
            <button onclick="pdf('tb_kritik','Laporan Kritik & Saran','p_nm_kritik','p_nip_kritik')" class="btn btn-print">CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_kritik">
                <thead><tr><th>Tanggal</th><th>Kepuasan</th><th>Pesan / Masukan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_kritik"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDvpFZtiG_fXLOf8okjafNm7gqbJZr2pSY",
        authDomain: "lapassistem.firebaseapp.com",
        databaseURL: "https://lapassistem-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "lapassistem",
        storageBucket: "lapassistem.firebasestorage.app",
        messagingSenderId: "951059663532",
        appId: "1:951059663532:web:716bc3010eecc741a4ed09",
        measurementId: "G-25HSNZ35ZH"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let listeners = {};

    // AUTH
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-box').style.display='none';
            document.getElementById('panel-box').style.display='block';
            loadSettings();
            // Load Default Live
            live('registrations','tb_fisik');
        } else {
            document.getElementById('login-box').style.display='block';
            document.getElementById('panel-box').style.display='none';
        }
    });

    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e=>alert(e.message)); }
    function logout() { auth.signOut(); }

    // TABS
    function tab(id) {
        ['set','fisik','online','urus','kritik'].forEach(x => document.getElementById('t-'+x).style.display='none');
        ['b1','b2','b3','b4','b5'].forEach(x => document.getElementById(x).className='tab-btn');
        
        document.getElementById('t-'+id).style.display='block';
        if(id=='set') document.getElementById('b1').classList.add('active');
        if(id=='fisik') document.getElementById('b2').classList.add('active');
        if(id=='online') document.getElementById('b3').classList.add('active');
        if(id=='urus') document.getElementById('b4').classList.add('active');
        if(id=='kritik') document.getElementById('b5').classList.add('active');

        if(id === 'urus') live('pengurusan', 'tb_urus');
        if(id === 'kritik') live('kritik_saran', 'tb_kritik');
    }

    // DATA LOADING
    function live(path, tbodyId) {
        if(listeners[path]) db.ref(path).off();
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "<tr><td colspan='9' style='text-align:center'>Memuat data...</td></tr>";
        
        listeners[path] = db.ref(path).limitToLast(100);
        listeners[path].on('value', s => render(s, tbodyId, path));
    }

    function load(path, tbodyId, dateId) {
        const d = document.getElementById(dateId).value;
        if(!d) return alert("Pilih tanggal!");
        if(listeners[path]) db.ref(path).off();
        
        db.ref(path).orderByChild('tgl').equalTo(d).on('value', s => render(s, tbodyId, path));
    }

    // RENDER DATA
    function render(snap, tbodyId, path) {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "";
        if(!snap.exists()) { tb.innerHTML = "<tr><td colspan='9' style='text-align:center'>Tidak ada data.</td></tr>"; return; }

        const arr = [];
        snap.forEach(c => arr.push({k:c.key, ...c.val()}));
        arr.reverse().forEach(v => {
            let row = `<tr data-key="${v.k}">`;
            
            // Render logic based on Table Type
            if(path === 'kritik_saran') {
                row += `
                    <td>${v.tgl}</td>
                    <td><b>${v.kepuasan}</b></td>
                    <td>${v.pesan}</td>
                    <td><button onclick="del('${path}','${v.k}')" class="act-btn bg-rej" title="Hapus">üóëÔ∏è</button></td>
                `;
            } else if (path === 'pengurusan') {
                let st = v.status=='accepted' ? '<span class="badge bg-acc">Disetujui</span>' : (v.status=='rejected'?'<span class="badge bg-rej">Ditolak</span>':'<span class="badge bg-wait">Menunggu</span>');
                
                // Button to open gallery
                let fileBtn = `<button onclick='openGallery(${JSON.stringify(v.images || {})})' style="background:#007bff; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:11px;">üìÇ LIHAT BERKAS</button>`;

                row += `
                    <td>${v.tgl}</td>
                    <td><b>${v.wbp}</b></td>
                    <td>${v.penjamin}<br><small>${v.nik}</small></td>
                    <td>${v.hub}</td>
                    <td style="text-align:center">${fileBtn}</td>
                    <td>${st}</td>
                    <td><input id="n-${v.k}" value="${v.note||''}" placeholder="Catatan..." style="font-size:11px;"></td>
                    <td style="display:flex;">
                        <button onclick="upd('${path}','${v.k}','accepted')" class="act-btn bg-acc">‚úÖ</button>
                        <button onclick="upd('${path}','${v.k}','rejected')" class="act-btn bg-rej">‚ùå</button>
                        <button onclick="del('${path}','${v.k}')" class="act-btn bg-rej">üóëÔ∏è</button>
                    </td>
                `;
            } else {
                // Kunjungan Standard (Fisik / Online)
                let st = v.status=='accepted' ? '<span class="badge bg-acc">OK</span>' : (v.status=='rejected'?'<span class="badge bg-rej">NO</span>':'<span class="badge bg-wait">WAIT</span>');
                let img = v.ktpUrl ? `<img src="${v.ktpUrl}" style="height:40px; cursor:pointer;" onclick="openImg('${v.ktpUrl}')">` : '-';
                
                row += `
                    <td style="font-weight:bold; color:#8B0000;">${v.noAntrian||'-'}</td>
                    <td>${v.tgl}<br><small>${v.jam||''}</small></td>
                    <td><b>${v.nama}</b><br><small>${v.telp}</small></td>
                    <td>${v.wbp}</td>
                    <td style="text-align:center">${img}</td>
                    <td>${st}</td>
                    <td><input id="n-${v.k}" value="${v.note||''}" placeholder="Note" style="font-size:11px;"></td>
                    <td style="display:flex;">
                        <button onclick="upd('${path}','${v.k}','accepted')" class="act-btn bg-acc">‚úÖ</button>
                        <button onclick="upd('${path}','${v.k}','rejected')" class="act-btn bg-rej">‚ùå</button>
                        <button onclick="del('${path}','${v.k}')" class="act-btn bg-rej">üóëÔ∏è</button>
                    </td>
                `;
            }
            row += "</tr>";
            tb.insertAdjacentHTML('beforeend', row);
        });
    }

    // ACTIONS
    function upd(path, key, st) {
        const note = document.getElementById(`n-${key}`).value;
        db.ref(path+'/'+key).update({status:st, note:note});
    }
    function del(path, key) { if(confirm("Hapus data?")) db.ref(path+'/'+key).remove(); }

    // SETTINGS
    const fields = ['app_name','kop_1','kop_2','kop_3','kop_4','announcement','txt_doc','txt_item'];
    function loadSettings() {
        db.ref('app_config').once('value', s => {
            if(s.exists()) {
                const d = s.val();
                fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = d[f]||""; });
            }
        });
    }
    function saveConf() {
        const d = {};
        fields.forEach(f => d[f] = document.getElementById(f).value);
        db.ref('app_config').update(d).then(() => alert("Tersimpan!"));
    }

    // MODALS
    window.openImg = (src) => { document.getElementById('imgView').src=src; document.getElementById('imgModal').style.display='flex'; }
    window.closeM = (id) => document.getElementById(id).style.display='none';
    
    window.openGallery = (images) => {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';
        const labels = {
            'u_ktp_wbp': 'KTP WBP', 'u_kk_wbp': 'KK WBP',
            'u_ktp_penj': 'KTP Penjamin', 'u_kk_penj': 'KK Penjamin',
            'u_surat_1': 'Surat Pernyataan', 'u_surat_2': 'Surat Jaminan',
            'u_foto': 'Foto Penjamin'
        };
        
        for(let key in images) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `<span style="font-size:10px; margin-bottom:5px;">${labels[key] || key}</span>
                             <img src="${images[key]}" onclick="openImg('${images[key]}')">`;
            grid.appendChild(div);
        }
        document.getElementById('galleryModal').style.display='flex';
    }

    // PDF PRINTING
    window.pdf = (tableId, title, nmId, nipId) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const petugas = document.getElementById(nmId).value;
        const nip = document.getElementById(nipId).value;
        
        if(!petugas) return alert("Isi nama petugas!");

        // KOP
        doc.setFontSize(14).setFont("times", "bold").text(document.getElementById('kop_1').value.toUpperCase(), 148, 15, {align:'center'});
        doc.text(document.getElementById('kop_2').value.toUpperCase(), 148, 22, {align:'center'});
        doc.setFontSize(16).text(document.getElementById('kop_3').value.toUpperCase(), 148, 30, {align:'center'});
        doc.setFontSize(11).setFont("times", "normal").text(document.getElementById('kop_4').value, 148, 37, {align:'center'});
        doc.line(10, 42, 287, 42);

        // TITLE
        doc.setFont("helvetica", "bold").setFontSize(12).text(title.toUpperCase(), 148, 52, {align:'center'});

        // DATA
        const table = document.getElementById(tableId);
        const body = [];
        const headers = [];
        
        // Get Headers
        for(let th of table.parentElement.querySelectorAll('thead th')) headers.push(th.innerText);

        // Get Body
        for (let row of table.rows) {
            const rowData = [];
            for (let cell of row.cells) {
                // Ignore button columns for specific tables if needed, or parse text
                if(cell.querySelector('input')) rowData.push(cell.querySelector('input').value);
                else if(cell.querySelector('button')) rowData.push(""); // Skip buttons
                else rowData.push(cell.innerText.replace(/\n/g, ' '));
            }
            body.push(rowData);
        }

        doc.autoTable({
            head: [headers],
            body: body,
            startY: 60,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2 },
            headStyles: { fillColor: [139, 0, 0] }
        });

        const fy = doc.lastAutoTable.finalY + 15;
        doc.text(`Arga Makmur, ${new Date().toLocaleDateString('id-ID')}`, 230, fy);
        doc.text("Petugas,", 230, fy+7);
        doc.text(`( ${petugas} )`, 230, fy+25);
        doc.text(`NIP. ${nip}`, 230, fy+30);

        doc.save(title + ".pdf");
    }
</script>
</body>
</html>
