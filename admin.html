<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Lapas (Final Pro)</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; overflow-x: auto; gap: 5px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 4px solid transparent; white-space: nowrap; transition: 0.3s; }
        .tab-btn:hover, .tab-btn.active { color: #8B0000; border-bottom-color: #8B0000; background: #fdfdfd; }
        
        .table-responsive { overflow-x: auto; max-height: 65vh; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; vertical-align: middle; }
        th { background: #8B0000; color: white; position: sticky; top: 0; z-index: 10; text-transform: uppercase; font-size: 11px; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background-color: #fff3cd; transition: 0.2s; }
        
        .filter-bar { background: #fff3cd; padding: 15px; border-radius: 8px; display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; justify-content: space-between; border: 1px solid #ffeeba; }
        .data-counter { font-weight: bold; color: #8B0000; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .btn { padding: 8px 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; height: 38px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-search { background: #007bff; }
        .btn-print { background: #17a2b8; }
        .btn-reset { background: #333; }
        .btn-del-all { background: #dc3545; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .badge { padding: 5px 10px; border-radius: 20px; color: white; font-size: 10px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .bg-wait { background: #6c757d; } .bg-acc { background: #28a745; } .bg-rej { background: #dc3545; }
        
        .act-btn { width: 32px; height: 32px; border: none; border-radius: 6px; color: white; cursor: pointer; margin-right: 2px; transition: 0.2s; }
        .act-btn:hover { transform: scale(1.1); }
        
        #imgModal, #galleryModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 90%; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; width: 100%; max-width: 900px; background: white; padding: 20px; border-radius: 12px; }
        .gallery-item { display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 5px; border-radius: 8px; border: 1px solid #ddd; }
        .gallery-item img { width: 100%; height: 140px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
        
        input, textarea, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
        #login-box { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="login-box">
    <h2 style="color:#8B0000; margin-bottom: 20px;"><i class="fas fa-user-shield"></i> ADMIN LAPAS</h2>
    <input id="email" type="email" placeholder="Email Administrator" style="margin-bottom:15px;">
    <input id="pass" type="password" placeholder="Password" style="margin-bottom:20px;">
    <button onclick="login()" class="btn btn-reset" style="width:100%; justify-content: center;">MASUK DASHBOARD</button>
</div>

<div id="imgModal"><span class="close-modal" onclick="closeM('imgModal')">&times;</span><img id="imgView" class="modal-content"></div>
<div id="galleryModal"><span class="close-modal" onclick="closeM('galleryModal')">&times;</span><div id="galleryGrid" class="gallery-grid"></div></div>

<div id="panel-box" class="container" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
        <h2 style="color:#8B0000; margin:0;"><i class="fas fa-building"></i> Dashboard Admin Lapas</h2>
        <button onclick="logout()" class="btn btn-reset"><i class="fas fa-sign-out-alt"></i> LOGOUT</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="tab('set')" id="b1"><i class="fas fa-cog"></i> PENGATURAN</button>
        <button class="tab-btn" onclick="tab('fisik')" id="b2"><i class="fas fa-users"></i> TATAP MUKA</button>
        <button class="tab-btn" onclick="tab('online')" id="b3"><i class="fas fa-video"></i> VIDEO CALL</button>
        <button class="tab-btn" onclick="tab('urus')" id="b4"><i class="fas fa-folder-open"></i> PENGURUSAN</button>
        <button class="tab-btn" onclick="tab('kritik')" id="b5"><i class="fas fa-comment-dots"></i> KRITIK SARAN</button>
    </div>

    <div id="t-set">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h3><i class="fas fa-id-card"></i> 1. Identitas & Kop Surat</h3>
                <label>Nama Aplikasi:</label> <input id="app_name">
                <label>Kop Baris 1:</label> <input id="kop_1">
                <label>Kop Baris 2:</label> <input id="kop_2">
                <label>Kop Baris 3:</label> <input id="kop_3">
                <label>Kop Baris 4:</label> <input id="kop_4">
                <label>Link Logo (URL):</label> <input id="logo_url">
                <label>Link Header (URL):</label> <input id="header_bg">
                <label>Pengumuman:</label> <textarea id="announcement"></textarea>
            </div>
            <div>
                <h3><i class="fas fa-clock"></i> 2. Konten & Jadwal</h3>
                <label>Syarat Kunjungan:</label> <textarea id="txt_doc"></textarea>
                <label>Aturan Barang:</label> <textarea id="txt_item"></textarea>
                <label>Syarat PB/CB/CMB:</label> <textarea id="txt_item"></textarea>
                <label>Jadwal (PIDUM & NARKOBA):</label> 
                <div style="display:flex; gap:5px;"><input id="sch_pidum"><input id="sch_narkoba"></div>
                <label>Jam Layanan:</label> 
                <div style="display:flex; gap:5px;"><input id="sch_mon_am"><input id="sch_mon_pm"></div>
                <label>Hari Lain:</label> 
                <div style="display:flex; gap:5px;"><input id="sch_fri"><input id="sch_sat"><input id="sch_sun"></div>
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div>
                <h3><i class="fas fa-store"></i> 3. Kontak & Toko</h3>
                <label>Info Toko:</label> <textarea id="toko_announce"></textarea>
                <label>Link Toko:</label> <input id="toko_link">
                <label>WA Pengaduan:</label> <input id="wa_pengaduan">
                <label>Link Channel:</label> <input id="wa_channel">
            </div>
            <div>
                <h3><i class="fas fa-share-alt"></i> 4. Media Sosial</h3>
                <label>Instagram:</label> <input id="soc_ig">
                <label>Facebook:</label> <input id="soc_fb">
                <label>Twitter/X:</label> <input id="soc_tw">
                <label>Youtube:</label> <input id="soc_yt">
            </div>
        </div>
        <button class="btn btn-acc" style="width:100%; margin-top:30px; height:50px; justify-content:center; font-size:16px;" onclick="saveConf()"><i class="fas fa-save"></i> SIMPAN SEMUA PENGATURAN</button>
    </div>

    <div id="t-fisik" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_fisik">Memuat...</div>
            <div style="display:flex; gap:5px;">
                <input type="date" id="d_fisik" style="width:auto;">
                <button onclick="load('registrations','tb_fisik','d_fisik')" class="btn btn-search"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="realtimeLoad('registrations','tb_fisik','cnt_fisik')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
                <button onclick="deleteAllData('registrations')" class="btn btn-del-all"><i class="fas fa-trash"></i> HAPUS SEMUA</button>
            </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center;">
            <i class="fas fa-print"></i> Cetak Laporan:
            <input id="p_nm_fisik" placeholder="Nama Petugas" style="max-width:200px;">
            <input id="p_nip_fisik" placeholder="NIP Petugas" style="max-width:200px;">
            <button onclick="pdf('tb_fisik','Laporan Kunjungan Tatap Muka','p_nm_fisik','p_nip_fisik')" class="btn btn-print"><i class="fas fa-file-pdf"></i> CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_fisik">
                <thead><tr><th>No Antrian</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_fisik"></tbody>
            </table>
        </div>
    </div>

    <div id="t-online" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_online">Memuat...</div>
            <div style="display:flex; gap:5px;">
                <input type="date" id="d_online" style="width:auto;">
                <button onclick="load('online_registrations','tb_online','d_online')" class="btn btn-search"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="realtimeLoad('online_registrations','tb_online','cnt_online')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
                <button onclick="deleteAllData('online_registrations')" class="btn btn-del-all"><i class="fas fa-trash"></i> HAPUS SEMUA</button>
            </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center;">
            <i class="fas fa-print"></i> Cetak Laporan:
            <input id="p_nm_online" placeholder="Nama Petugas" style="max-width:200px;">
            <input id="p_nip_online" placeholder="NIP Petugas" style="max-width:200px;">
            <button onclick="pdf('tb_online','Laporan Video Call','p_nm_online','p_nip_online')" class="btn btn-print"><i class="fas fa-file-pdf"></i> CETAK PDF</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_online">
                <thead><tr><th>No Antrian</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_online"></tbody>
            </table>
        </div>
    </div>

    <div id="t-urus" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_urus">Memuat...</div>
            <div style="display:flex; gap:5px;">
                <input type="date" id="d_urus" style="width:auto;">
                <button onclick="load('pengurusan','tb_urus','d_urus')" class="btn btn-search"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="realtimeLoad('pengurusan','tb_urus','cnt_urus')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
                <button onclick="deleteAllData('pengurusan')" class="btn btn-del-all"><i class="fas fa-trash"></i> HAPUS SEMUA</button>
            </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center;">
            <i class="fas fa-print"></i> Cetak Laporan:
            <input id="p_nm_urus" placeholder="Nama Petugas" style="max-width:200px;">
            <input id="p_nip_urus" placeholder="NIP Petugas" style="max-width:200px;">
            <button onclick="pdf('tb_urus','Laporan Pengurusan PB/CB/CMB','p_nm_urus','p_nip_urus')" class="btn btn-print"><i class="fas fa-file-pdf"></i> CETAK PDF RAPI</button>
        </div>
        <div class="table-responsive">
            <table id="tbl_urus">
                <thead><tr><th>Tanggal</th><th>Jenis</th><th>WBP</th><th>Penjamin</th><th>Hubungan</th><th>Berkas</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_urus"></tbody>
            </table>
        </div>
    </div>

    <div id="t-kritik" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_kritik">Memuat...</div>
            <div style="display:flex; gap:5px;">
                <button onclick="realtimeLoad('kritik_saran','tb_kritik','cnt_kritik')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
                <button onclick="deleteAllData('kritik_saran')" class="btn btn-del-all"><i class="fas fa-trash"></i> HAPUS SEMUA</button>
                <button onclick="pdf('tb_kritik','Laporan Kritik & Saran','p_nm_kritik','p_nip_kritik')" class="btn btn-print"><i class="fas fa-file-pdf"></i> CETAK PDF</button>
            </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center;">
            <i class="fas fa-print"></i> Cetak Laporan:
            <input id="p_nm_kritik" placeholder="Nama Petugas" style="max-width:200px;">
            <input id="p_nip_kritik" placeholder="NIP Petugas" style="max-width:200px;">
        </div>
        <div class="table-responsive">
            <table id="tbl_kritik">
                <thead><tr><th>Tanggal</th><th>Kepuasan</th><th>Pesan / Masukan</th><th>Aksi</th></tr></thead>
                <tbody id="tb_kritik"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // === 1. KONFIGURASI FIREBASE ===
    const firebaseConfig = {
        apiKey: "AIzaSyDvpFZtiG_fXLOf8okjafNm7gqbJZr2pSY",
        authDomain: "lapassistem.firebaseapp.com",
        databaseURL: "https://lapassistem-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "lapassistem",
        storageBucket: "lapassistem.firebasestorage.app",
        messagingSenderId: "951059663532",
        appId: "1:951059663532:web:716bc3010eecc741a4ed09",
        measurementId: "G-25HSNZ35ZH"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentListener = null; // Handler Listener Aktif
    const DATA_CACHE = {}; // Cache Gambar

    // === 2. AUTH & INIT ===
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-box').style.display='none';
            document.getElementById('panel-box').style.display='block';
            loadSettings();
            realtimeLoad('registrations','tb_fisik','cnt_fisik'); // Load Default
        } else {
            document.getElementById('login-box').style.display='block';
            document.getElementById('panel-box').style.display='none';
        }
    });

    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e=>alert(e.message)); }
    function logout() { auth.signOut(); }

    function tab(id) {
        ['set','fisik','online','urus','kritik'].forEach(x => document.getElementById('t-'+x).style.display='none');
        ['b1','b2','b3','b4','b5'].forEach(x => document.getElementById(x).className='tab-btn');
        document.getElementById('t-'+id).style.display='block';
        
        if(id=='set') document.getElementById('b1').classList.add('active');
        if(id=='fisik') { document.getElementById('b2').classList.add('active'); realtimeLoad('registrations','tb_fisik','cnt_fisik'); }
        if(id=='online') { document.getElementById('b3').classList.add('active'); realtimeLoad('online_registrations','tb_online','cnt_online'); }
        if(id=='urus') { document.getElementById('b4').classList.add('active'); realtimeLoad('pengurusan','tb_urus','cnt_urus'); }
        if(id=='kritik') { document.getElementById('b5').classList.add('active'); realtimeLoad('kritik_saran','tb_kritik','cnt_kritik'); }
    }

    // === 3. REALTIME LOAD (DATA BERUBAH INSTAN) ===
    function realtimeLoad(path, tbodyId, cntId) {
        const tb = document.getElementById(tbodyId);
        const cnt = document.getElementById(cntId);
        
        if(currentListener) db.ref().off(); // Reset Listener
        
        tb.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px; color:blue;'><i class='fas fa-spinner fa-spin'></i> Menghubungkan ke Database...</td></tr>";
        cnt.innerText = "Connecting...";
        
        // GUNAKAN .ON() UNTUK REALTIME UPDATE
        const ref = db.ref(path).limitToLast(500);
        currentListener = ref;
        
        ref.on('value', snapshot => {
            render(snapshot, tbodyId, path, cntId);
        });
    }

    // === 4. HAPUS SEMUA DATA ===
    function deleteAllData(path) {
        if(confirm("⚠️ PERINGATAN: Apakah Anda yakin ingin MENGHAPUS SEMUA DATA di menu ini?")) {
            if(confirm("❗ DATA YANG DIHAPUS TIDAK BISA DIKEMBALIKAN. Lanjutkan?")) {
                db.ref(path).remove()
                .then(() => alert("✅ Semua data berhasil dihapus."))
                .catch(e => alert("Gagal menghapus: " + e.message));
            }
        }
    }

    // === 5. FILTER TANGGAL ===
    function load(path, tbodyId, dateId) {
        const d = document.getElementById(dateId).value;
        if(!d) return alert("Pilih tanggal dulu!");
        
        if(currentListener) db.ref().off();
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px;'>Mencari data tanggal "+d+"...</td></tr>";
        
        db.ref(path).orderByChild('tgl').equalTo(d).once('value').then(snap => {
            render(snap, tbodyId, path, null);
        });
    }

    // === 6. RENDER (TAMPILKAN DATA) ===
    function render(snap, tbodyId, path, cntId) {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "";
        
        if(!snap.exists()) { 
            tb.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px; color:#666;'>Belum ada data.</td></tr>"; 
            if(cntId) document.getElementById(cntId).innerText = "Total: 0 Data";
            return; 
        }

        const arr = [];
        snap.forEach(c => {
            const val = c.val();
            const key = c.key;
            DATA_CACHE[key] = val; // Cache data untuk modal
            arr.push({k:key, ...val});
        });
        
        if(cntId) document.getElementById(cntId).innerText = `Total: ${arr.length} Data`;

        arr.reverse().forEach(v => {
            try {
                let row = `<tr data-key="${v.k}">`;
                
                // TOMBOL AKSI
                const btnAcc = `<button onclick="upd('${path}','${v.k}','accepted')" class="act-btn bg-acc" title="Terima"><i class="fas fa-check"></i></button>`;
                const btnRej = `<button onclick="upd('${path}','${v.k}','rejected')" class="act-btn bg-rej" title="Tolak"><i class="fas fa-times"></i></button>`;
                const btnDel = `<button onclick="del('${path}','${v.k}')" class="act-btn bg-rej" title="Hapus"><i class="fas fa-trash"></i></button>`;
                const actions = `<div style="display:flex; justify-content:center;">${btnAcc}${btnRej}${btnDel}</div>`;

                // STATUS BADGE
                let statusBadge = '<span class="badge bg-wait">MENUNGGU</span>';
                if(v.status === 'accepted') statusBadge = '<span class="badge bg-acc">DISETUJUI</span>';
                if(v.status === 'rejected') statusBadge = '<span class="badge bg-rej">DITOLAK</span>';

                // NOTE INPUT
                const noteInput = `<input id="n-${v.k}" value="${v.note||''}" placeholder="Catatan..." onblur="saveNote('${path}','${v.k}',this.value)" style="font-size:11px;">`;

                if(path === 'kritik_saran') {
                    row += `<td>${v.tgl}</td><td><b>${v.kepuasan}</b></td><td>${v.pesan}</td>
                            <td style="text-align:center">${btnDel}</td>`;
                } 
                else if (path === 'pengurusan') {
                    let fileBtn = v.images ? `<button onclick='showFiles("${v.k}")' style="background:#17a2b8; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:10px;"><i class="fas fa-folder"></i> BERKAS</button>` : '-';
                    
                    row += `<td>${v.tgl}</td><td>${v.jenis}</td><td><b>${v.wbp}</b></td>
                            <td>${v.penjamin}<br><small>${v.nik}</small></td>
                            <td>${v.hub}</td><td style="text-align:center">${fileBtn}</td>
                            <td style="text-align:center">${statusBadge}</td>
                            <td>${noteInput}</td><td>${actions}</td>`;
                } 
                else { 
                    // TATAP MUKA & ONLINE
                    let imgBtn = v.ktpUrl ? `<img src="${v.ktpUrl}" style="height:35px; border-radius:3px; cursor:pointer; border:1px solid #ccc;" onclick="showSingleImg('${v.k}')">` : '-';
                    
                    row += `<td style="font-weight:bold; color:#8B0000; text-align:center;">${v.noAntrian||'-'}</td>
                            <td>${v.tgl}<br><small style="color:#666;">${v.jam||''}</small></td>
                            <td><b>${v.nama}</b><br><small>${v.telp}</small></td>
                            <td>${v.wbp}</td>
                            <td style="text-align:center">${imgBtn}</td>
                            <td style="text-align:center">${statusBadge}</td>
                            <td>${noteInput}</td><td>${actions}</td>`;
                }
                row += "</tr>";
                tb.insertAdjacentHTML('beforeend', row);
            } catch (e) { console.error(e); }
        });
    }

    // === 7. FUNGSI AKSI (UPDATE & DELETE) ===
    function upd(path, key, st) { 
        // Langsung update status di firebase, listener akan otomatis merender ulang (INSTAN)
        db.ref(path+'/'+key).update({status:st}); 
    }
    
    function saveNote(path, key, val) {
        db.ref(path+'/'+key).update({note:val});
    }

    function del(path, key) { 
        if(confirm("Hapus data ini?")) {
            db.ref(path+'/'+key).remove(); // Listener otomatis update UI
        }
    }

    // === 8. PDF GENERATOR (RAPI & LENGKAP) ===
    window.pdf = (tableId, title, nmId, nipId) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
        
        const petugas = document.getElementById(nmId).value;
        const nip = document.getElementById(nipId).value;
        if(!petugas) return alert("Mohon isi Nama Petugas penandatangan!");

        // KOP SURAT
        const k1 = document.getElementById('kop_1').value.toUpperCase();
        const k2 = document.getElementById('kop_2').value.toUpperCase();
        const k3 = document.getElementById('kop_3').value.toUpperCase();
        const k4 = document.getElementById('kop_4').value;

        doc.setFont("times", "bold"); doc.setFontSize(14);
        doc.text(k1, 148, 15, {align:'center'});
        doc.text(k2, 148, 22, {align:'center'});
        doc.setFontSize(16);
        doc.text(k3, 148, 30, {align:'center'});
        doc.setFontSize(11); doc.setFont("times", "normal");
        doc.text(k4, 148, 37, {align:'center'});
        doc.setLineWidth(0.5); doc.line(10, 42, 287, 42);

        // JUDUL
        doc.setFont("helvetica", "bold"); doc.setFontSize(12);
        doc.text(title.toUpperCase(), 148, 52, {align:'center'});
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text("Dicetak Tanggal: " + new Date().toLocaleDateString('id-ID'), 148, 58, {align:'center'});

        // DATA TABEL
        const table = document.getElementById(tableId);
        const headers = [];
        const body = [];

        // Ambil Header (skip kolom aksi)
        for(let th of table.parentElement.querySelectorAll('thead th')) {
            if(th.innerText !== 'Aksi' && th.innerText !== 'KTP' && th.innerText !== 'Berkas') {
                headers.push(th.innerText);
            }
        }

        // Ambil Body
        for (let row of table.rows) {
            const rowData = [];
            let skip = false;
            for (let i = 0; i < row.cells.length; i++) {
                const cell = row.cells[i];
                // Skip kolom gambar/aksi
                if(cell.innerHTML.includes('<button') && cell.innerHTML.includes('act-btn')) continue; 
                if(cell.innerHTML.includes('LIHAT BERKAS')) continue;
                if(cell.querySelector('img')) continue;

                // Ambil Text Murni
                let text = cell.innerText.trim();
                
                // Ambil Value Input (Catatan)
                if(cell.querySelector('input')) text = cell.querySelector('input').value;
                
                rowData.push(text);
            }
            if(rowData.length > 0) body.push(rowData);
        }

        doc.autoTable({
            head: [headers],
            body: body,
            startY: 65,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 3, valign: 'middle' },
            headStyles: { fillColor: [139, 0, 0], textColor: 255, fontStyle: 'bold', halign: 'center' },
            columnStyles: { 0: {halign: 'center', fontStyle:'bold'} }, // No Antrian Bold
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

        // TANDA TANGAN
        let finalY = doc.lastAutoTable.finalY + 20;
        if(finalY > 170) { doc.addPage(); finalY = 20; }

        const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
        
        doc.setFont("times", "normal");
        doc.text(`Arga Makmur, ${dateStr}`, 230, finalY);
        doc.text("Petugas Layanan,", 230, finalY + 6);
        doc.setFont("times", "bold");
        doc.text(`( ${petugas} )`, 230, finalY + 25);
        doc.setFont("times", "normal");
        doc.text(`NIP. ${nip}`, 230, finalY + 30);

        doc.save(title.replace(/\s+/g, '_') + ".pdf");
    }

    // SETTINGS & MODALS (SAMA SEPERTI SEBELUMNYA)
    const fields = ['app_name','logo_url','header_bg','announcement','kop_1','kop_2','kop_3','kop_4', 'sch_pidum', 'sch_narkoba','sch_mon_am','sch_mon_pm','sch_fri','sch_sat','sch_sun', 'txt_doc','txt_item','txt_pb_cb', 'toko_announce','toko_link','wa_pengaduan', 'wa_channel','soc_ig','soc_fb','soc_tw','soc_yt'];

    function loadSettings() {
        db.ref('app_config').once('value', s => {
            if(s.exists()) {
                const d = s.val();
                fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = d[f]||""; });
            }
        });
    }
    function saveConf() {
        const d = {};
        fields.forEach(f => { if(document.getElementById(f)) d[f] = document.getElementById(f).value; });
        db.ref('app_config').update(d).then(() => alert("Pengaturan Tersimpan!"));
    }

    window.showSingleImg = (key) => {
        const data = DATA_CACHE[key];
        if(data && data.ktpUrl) { document.getElementById('imgView').src = data.ktpUrl; document.getElementById('imgModal').style.display = 'flex'; }
    }
    window.showFiles = (key) => {
        const data = DATA_CACHE[key];
        const grid = document.getElementById('galleryGrid'); grid.innerHTML = '';
        if(data && data.images) {
            const labels = {'u_ktp_wbp': 'KTP WBP', 'u_kk_wbp': 'KK WBP', 'u_ktp_penj': 'KTP Penjamin', 'u_kk_penj': 'KK Penjamin', 'u_surat_1': 'Surat Pernyataan', 'u_surat_2': 'Surat Jaminan', 'u_foto': 'Foto Penjamin'};
            for(let k in data.images) {
                const div = document.createElement('div'); div.className = 'gallery-item';
                div.innerHTML = `<span style="font-size:10px; margin-bottom:5px;">${labels[k] || k}</span><img src="${data.images[k]}" onclick="document.getElementById('imgView').src=this.src; document.getElementById('imgModal').style.display='flex';">`;
                grid.appendChild(div);
            }
            document.getElementById('galleryModal').style.display='flex';
        }
    }
    window.closeM = (id) => document.getElementById(id).style.display='none';
</script>
</body>
</html>

