<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Lapas (Final Pro)</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
    :root {
        --primary: #2c3e50;
        --accent: #28a745;
        --bg-light: #f4f6f9;
        --card-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-light); padding: 20px; margin: 0; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; background: transparent; }
    
    /* HEADER ADMIN */
    .admin-header { background: white; padding: 20px 30px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--card-shadow); margin-bottom: 25px; }
    .admin-header h2 { margin: 0; color: var(--primary); font-size: 20px; display: flex; align-items: center; gap: 12px; }
    
    /* TABS */
    .tabs { display: flex; background: white; padding: 10px; border-radius: 12px; box-shadow: var(--card-shadow); gap: 10px; overflow-x: auto; margin-bottom: 25px; }
    .tab-btn { padding: 12px 20px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: #7f8c8d; border-radius: 8px; transition: 0.3s; white-space: nowrap; display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .tab-btn:hover { background: #f8f9fa; color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.3); }

    /* CARD SYSTEM FOR SETTINGS */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
    .setting-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid #eff2f5; transition: transform 0.2s; }
    .setting-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; border-bottom: 2px solid #f5f5f5; padding-bottom: 15px; }
    .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
    .icon-blue { background: linear-gradient(135deg, #3498db, #2980b9); }
    .icon-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .icon-orange { background: linear-gradient(135deg, #e67e22, #d35400); }
    .icon-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .card-title { font-size: 16px; font-weight: 700; color: var(--primary); margin: 0; }

    /* INPUT STYLING */
    .input-group { margin-bottom: 15px; }
    .input-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #95a5a6; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
    .styled-input { width: 100%; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 10px; background: #fcfcfc; font-family: inherit; font-size: 13px; color: #2c3e50; transition: 0.3s; box-sizing: border-box; }
    .styled-input:focus { border-color: var(--accent); background: white; outline: none; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1); }
    
    /* RICH EDITOR */
    .rich-box { border: 1px solid #e0e0e0; border-radius: 10px; background: #fff; overflow: hidden; transition: 0.3s; }
    .rich-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1); }
    .rich-toolbar { background: #f8f9fa; padding: 8px; border-bottom: 1px solid #eee; display: flex; gap: 5px; }
    .tool-btn { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; cursor: pointer; color: #555; transition: 0.2s; }
    .tool-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .rich-edit { min-height: 120px; max-height: 300px; overflow-y: auto; padding: 15px; outline: none; font-size: 13px; line-height: 1.6; color: #444; }
    .rich-edit img { max-width: 100%; border-radius: 5px; }

    /* BUTTONS */
    .btn-save-fancy { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3); transition: all 0.3s ease; cursor: pointer; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-save-fancy:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4); }

    /* UTILS & TABLES */
    .filter-bar { background: white; padding: 20px; border-radius: 15px; display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; box-shadow: var(--card-shadow); }
    .data-counter { font-weight: bold; color: var(--accent); background: #e8f5e9; padding: 8px 15px; border-radius: 50px; font-size: 12px; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; height: 42px; font-size: 12px; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-search { background: linear-gradient(135deg, #3498db, #2980b9); } 
    .btn-print { background: linear-gradient(135deg, #17a2b8, #117a8b); } 
    .btn-reset { background: linear-gradient(135deg, #34495e, #2c3e50); } 
    .btn-del-all { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    
    .table-responsive { background: white; padding: 5px; border-radius: 15px; box-shadow: var(--card-shadow); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { background: #f8f9fa; color: #444; padding: 15px; text-transform: uppercase; font-size: 11px; border-bottom: 2px solid #eee; font-weight: 700; }
    td { padding: 15px; border-bottom: 1px solid #f1f1f1; color: #555; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    
    .badge { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
    .bg-wait { background: #fff3cd; color: #856404; } .bg-acc { background: #d4edda; color: #155724; } .bg-rej { background: #f8d7da; color: #721c24; }
    
    .act-btn { width: 32px; height: 32px; border: none; border-radius: 8px; color: white; cursor: pointer; margin-right: 4px; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .bg-acc { background: #2ecc71; } .bg-rej { background: #e74c3c; }

    #login-box { max-width: 400px; margin: 80px auto; background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<div id="login-box">
    <div style="font-size: 50px; color: #555; margin-bottom: 10px;"><i class="fas fa-shield-alt"></i></div>
    <h2 style="color:#333; margin-bottom: 5px;">Admin Login</h2>
    <p style="color:#777; font-size:12px; margin-bottom: 25px;">Masuk untuk mengelola layanan lapas</p>
    <input id="email" type="email" placeholder="Email Administrator" style="margin-bottom:15px; background:#f9f9f9;">
    <input id="pass" type="password" placeholder="Password" style="margin-bottom:25px; background:#f9f9f9;">
    <button onclick="login()" class="btn-save-fancy" style="margin-top:0;">MASUK DASHBOARD <i class="fas fa-arrow-right"></i></button>
</div>

<div id="imgModal"><span class="close-modal" onclick="closeM('imgModal')">&times;</span><img id="imgView" class="modal-content"></div>
<div id="galleryModal"><span class="close-modal" onclick="closeM('galleryModal')">&times;</span><div id="galleryGrid" class="gallery-grid"></div></div>

<div id="panel-box" class="container" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
        <h2 style="color:#555; margin:0; display:flex; align-items:center; gap:10px;"><i class="fas fa-landmark"></i> Dashboard Admin Lapas</h2>
        <button onclick="logout()" class="btn btn-del-all" style="height:40px;"><i class="fas fa-sign-out-alt"></i> LOGOUT</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="tab('set')" id="b1"><i class="fas fa-cogs"></i> PENGATURAN</button>
        <button class="tab-btn" onclick="tab('fisik')" id="b2"><i class="fas fa-users"></i> TATAP MUKA</button>
        <button class="tab-btn" onclick="tab('online')" id="b3"><i class="fas fa-video"></i> VIDEO CALL</button>
        <button class="tab-btn" onclick="tab('urus')" id="b4"><i class="fas fa-folder-open"></i> PENGURUSAN</button>
        <button class="tab-btn" onclick="tab('kritik')" id="b5"><i class="fas fa-comments"></i> KRITIK SARAN</button>
    </div>

    <div id="t-set">
    <div class="settings-grid">
        
        <div class="setting-card">
            <div class="card-header">
                <div class="card-icon icon-blue"><i class="fas fa-id-card"></i></div>
                <h3 class="card-title">Identitas Aplikasi</h3>
            </div>
            <div class="input-group">
                <label class="input-label">Nama Aplikasi</label>
                <input id="app_name" class="styled-input" placeholder="Contoh: Lapas Digital">
            </div>
            <div class="input-group">
                <label class="input-label">Link Logo (URL)</label>
                <input id="logo_url" class="styled-input" placeholder="https://...">
            </div>
            <div class="input-group">
                <label class="input-label">Link Header Background (URL)</label>
                <input id="header_bg" class="styled-input" placeholder="https://...">
            </div>
            <div class="input-group">
                <label class="input-label">Pengumuman (Info Penting)</label>
                <div class="rich-box">
                    <div class="rich-toolbar">
                        <button class="tool-btn" onclick="fmt('announcement_edit', 'bold')"><b>B</b></button>
                        <button class="tool-btn" onclick="fmt('announcement_edit', 'italic')"><i>I</i></button>
                        <button class="tool-btn" onclick="insImg('announcement_edit')"><i class="fas fa-image"></i></button>
                    </div>
                    <div id="announcement_edit" class="rich-edit" contenteditable="true" placeholder="Tulis info penting..."></div>
                </div>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="card-icon icon-purple"><i class="fas fa-file-pdf"></i></div>
                <h3 class="card-title">Kop Surat (Cetak PDF)</h3>
            </div>
            <div class="input-group">
                <label class="input-label">Baris 1 (Kementerian)</label>
                <input id="kop_1" class="styled-input" placeholder="KEMENTERIAN HUKUM DAN HAM RI">
            </div>
            <div class="input-group">
                <label class="input-label">Baris 2 (Wilayah)</label>
                <input id="kop_2" class="styled-input" placeholder="KANTOR WILAYAH BENGKULU">
            </div>
            <div class="input-group">
                <label class="input-label">Baris 3 (Satuan Kerja)</label>
                <input id="kop_3" class="styled-input" placeholder="LEMBAGA PEMASYARAKATAN KELAS IIB ARGA MAKMUR">
            </div>
            <div class="input-group">
                <label class="input-label">Baris 4 (Alamat Lengkap)</label>
                <input id="kop_4" class="styled-input" placeholder="Jl. Jenderal Sudirman No. 1...">
            </div>
        </div>

        <div class="setting-card" style="grid-column: span 1 / -1;">
            <div class="card-header">
                <div class="card-icon icon-orange"><i class="fas fa-file-alt"></i></div>
                <h3 class="card-title">Konten Informasi Layanan</h3>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <label class="input-label">Syarat Kunjungan & Dokumen</label>
                    <div class="rich-box">
                        <div class="rich-toolbar">
                            <button class="tool-btn" onclick="fmt('txt_doc_edit', 'bold')"><b>B</b></button>
                            <button class="tool-btn" onclick="fmt('txt_doc_edit', 'insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                            <button class="tool-btn" onclick="insImg('txt_doc_edit')"><i class="fas fa-image"></i></button>
                        </div>
                        <div id="txt_doc_edit" class="rich-edit" contenteditable="true"></div>
                    </div>
                </div>
                <div>
                    <label class="input-label">Aturan Barang Bawaan</label>
                    <div class="rich-box">
                        <div class="rich-toolbar">
                            <button class="tool-btn" onclick="fmt('txt_item_edit', 'bold')"><b>B</b></button>
                            <button class="tool-btn" onclick="fmt('txt_item_edit', 'insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                            <button class="tool-btn" onclick="insImg('txt_item_edit')"><i class="fas fa-image"></i></button>
                        </div>
                        <div id="txt_item_edit" class="rich-edit" contenteditable="true"></div>
                    </div>
                </div>
                <div>
                    <label class="input-label">Syarat Lengkap PB/CB/CMB</label>
                    <div class="rich-box">
                        <div class="rich-toolbar">
                            <button class="tool-btn" onclick="fmt('txt_pb_cb_edit', 'bold')"><b>B</b></button>
                            <button class="tool-btn" onclick="fmt('txt_pb_cb_edit', 'italic')"><i>I</i></button>
                            <button class="tool-btn" onclick="fmt('txt_pb_cb_edit', 'insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                            <button class="tool-btn" onclick="insImg('txt_pb_cb_edit')"><i class="fas fa-image"></i> Gambar</button>
                        </div>
                        <div id="txt_pb_cb_edit" class="rich-edit" contenteditable="true"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="card-icon icon-green"><i class="fas fa-clock"></i></div>
                <h3 class="card-title">Jadwal Pelayanan</h3>
            </div>
            <div class="input-group">
                <label class="input-label">Jadwal Tahanan PIDUM</label>
                <input id="sch_pidum" class="styled-input" placeholder="Contoh: Senin & Rabu">
            </div>
            <div class="input-group">
                <label class="input-label">Jadwal Tahanan NARKOBA</label>
                <input id="sch_narkoba" class="styled-input" placeholder="Contoh: Selasa & Kamis">
            </div>
            <div style="display:flex; gap:15px; margin-top:10px;">
                <div style="flex:1;">
                    <label class="input-label">Jam Pagi</label>
                    <input id="sch_mon_am" class="styled-input" placeholder="08.00 - 12.00">
                </div>
                <div style="flex:1;">
                    <label class="input-label">Jam Siang</label>
                    <input id="sch_mon_pm" class="styled-input" placeholder="13.00 - 15.00">
                </div>
            </div>
            <div style="margin-top:15px;">
                <label class="input-label">Jadwal Khusus</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <input id="sch_fri" class="styled-input" placeholder="Jumat">
                    <input id="sch_sat" class="styled-input" placeholder="Sabtu">
                    <input id="sch_sun" class="styled-input" placeholder="Minggu">
                </div>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="card-icon icon-blue"><i class="fas fa-share-alt"></i></div>
                <h3 class="card-title">Kontak & Media Sosial</h3>
            </div>
            <div class="input-group">
                <label class="input-label">Info Toko Lapas</label>
                <input id="toko_announce" class="styled-input" placeholder="Kantin buka jam...">
            </div>
            <div class="input-group">
                <label class="input-label">Link Aplikasi Toko</label>
                <input id="toko_link" class="styled-input" placeholder="https://...">
            </div>
            <div class="input-group">
                <label class="input-label">WhatsApp Pengaduan (Format: 628xxx)</label>
                <input id="wa_pengaduan" class="styled-input" type="number" placeholder="62812345678">
            </div>
            <div class="input-group">
                <label class="input-label">Link Saluran Informasi</label>
                <input id="wa_channel" class="styled-input" placeholder="https://whatsapp.com/channel/...">
            </div>
            
            <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
                <label class="input-label">Media Sosial (URL Lengkap)</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input id="soc_ig" class="styled-input" placeholder="Instagram URL">
                    <input id="soc_fb" class="styled-input" placeholder="Facebook URL">
                    <input id="soc_tw" class="styled-input" placeholder="Twitter URL">
                    <input id="soc_yt" class="styled-input" placeholder="YouTube URL">
                </div>
            </div>
        </div>
    </div>

    <button class="btn-save-fancy" onclick="saveConf()">
        <i class="fas fa-save"></i> SIMPAN SEMUA PERUBAHAN
    </button>
</div>

    <div id="t-fisik" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_fisik">Memuat...</div>
            <div style="display:flex; gap:5px;">
               <input type="date" id="d_fisik" style="width:auto;">
               <button onclick="load('registrations','tb_fisik','d_fisik')" class="btn btn-search"><i class="fas fa-search"></i> Cari</button>
               <button onclick="realtimeLoad('registrations','tb_fisik','cnt_fisik')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
               <button onclick="deleteAllData('registrations')" class="btn btn-del-all"><i class="fas fa-trash"></i> Hapus Semua</button>
           </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <i class="fas fa-print"></i> <b>Cetak:</b>
            <input id="p_nm_fisik" placeholder="Nama Petugas" style="margin:0; width:150px;">
            <input id="p_nip_fisik" placeholder="NIP Petugas" style="margin:0; width:150px;">
            <button onclick="pdf('tbl_fisik','Laporan Kunjungan Tatap Muka','p_nm_fisik','p_nip_fisik')" class="btn btn-print"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        <div class="table-responsive"><table id="tbl_fisik"><thead><tr><th>No Antrian</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead><tbody id="tb_fisik"></tbody></table></div>
    </div>

    <div id="t-online" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_online">Memuat...</div>
            <div style="display:flex; gap:5px;">
               <input type="date" id="d_online" style="width:auto;">
               <button onclick="load('online_registrations','tb_online','d_online')" class="btn btn-search"><i class="fas fa-search"></i> Cari</button>
               <button onclick="realtimeLoad('online_registrations','tb_online','cnt_online')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
               <button onclick="deleteAllData('online_registrations')" class="btn btn-del-all"><i class="fas fa-trash"></i> Hapus Semua</button>
           </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <i class="fas fa-print"></i> <b>Cetak:</b>
            <input id="p_nm_online" placeholder="Nama Petugas" style="margin:0; width:150px;">
            <input id="p_nip_online" placeholder="NIP Petugas" style="margin:0; width:150px;">
            <button onclick="pdf('tbl_online','Laporan Video Call','p_nm_online','p_nip_online')" class="btn btn-print"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        <div class="table-responsive"><table id="tbl_online"><thead><tr><th>No Antrian</th><th>Waktu</th><th>Pengunjung</th><th>WBP</th><th>KTP</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead><tbody id="tb_online"></tbody></table></div>
    </div>

    <div id="t-urus" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_urus">Memuat...</div>
            <div style="display:flex; gap:5px;">
               <input type="date" id="d_urus" style="width:auto;">
               <button onclick="load('pengurusan','tb_urus','d_urus')" class="btn btn-search"><i class="fas fa-search"></i> Cari</button>
               <button onclick="realtimeLoad('pengurusan','tb_urus','cnt_urus')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
               <button onclick="deleteAllData('pengurusan')" class="btn btn-del-all"><i class="fas fa-trash"></i> Hapus Semua</button>
           </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <i class="fas fa-print"></i> <b>Cetak:</b>
            <input id="p_nm_urus" placeholder="Nama Petugas" style="margin:0; width:150px;">
            <input id="p_nip_urus" placeholder="NIP Petugas" style="margin:0; width:150px;">
            <button onclick="pdf('tbl_urus','Laporan Pengurusan PB/CB/CMB','p_nm_urus','p_nip_urus')" class="btn btn-print"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        <div class="table-responsive"><table id="tbl_urus"><thead><tr><th>Tanggal</th><th>Jenis</th><th>WBP</th><th>Penjamin</th><th>Hubungan</th><th>Berkas</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead><tbody id="tb_urus"></tbody></table></div>
    </div>

    <div id="t-kritik" style="display:none;">
        <div class="filter-bar">
            <div class="data-counter" id="cnt_kritik">Memuat...</div>
            <div style="display:flex; gap:5px;">
               <button onclick="realtimeLoad('kritik_saran','tb_kritik','cnt_kritik')" class="btn btn-reset"><i class="fas fa-sync"></i> Refresh</button>
               <button onclick="deleteAllData('kritik_saran')" class="btn btn-del-all"><i class="fas fa-trash"></i> Hapus Semua</button>
           </div>
        </div>
        <div class="print-area" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
             <i class="fas fa-print"></i> <b>Cetak:</b>
            <input id="p_nm_kritik" placeholder="Nama Petugas" style="margin:0; width:150px;">
            <input id="p_nip_kritik" placeholder="NIP Petugas" style="margin:0; width:150px;">
            <button onclick="pdf('tbl_kritik','Laporan Kritik & Saran','p_nm_kritik','p_nip_kritik')" class="btn btn-print"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        <div class="table-responsive"><table id="tbl_kritik"><thead><tr><th>Tanggal</th><th>Kepuasan</th><th>Pesan / Masukan</th><th>Aksi</th></tr></thead><tbody id="tb_kritik"></tbody></table></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDvpFZtiG_fXLOf8okjafNm7gqbJZr2pSY",
        authDomain: "lapassistem.firebaseapp.com",
        databaseURL: "https://lapassistem-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "lapassistem",
        storageBucket: "lapassistem.firebasestorage.app",
        messagingSenderId: "951059663532",
        appId: "1:951059663532:web:716bc3010eecc741a4ed09",
        measurementId: "G-25HSNZ35ZH"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentListener = null;
    const DATA_CACHE = {};

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-box').style.display='none';
            document.getElementById('panel-box').style.display='block';
            loadSettings();
            realtimeLoad('registrations','tb_fisik','cnt_fisik');
        } else {
            document.getElementById('login-box').style.display='block';
            document.getElementById('panel-box').style.display='none';
        }
    });

    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e=>alert(e.message)); }
    function logout() { auth.signOut(); }

    function tab(id) {
        ['set','fisik','online','urus','kritik'].forEach(x => document.getElementById('t-'+x).style.display='none');
        ['b1','b2','b3','b4','b5'].forEach(x => document.getElementById(x).className='tab-btn');
        document.getElementById('t-'+id).style.display='block';
        document.getElementById(id=='set'?'b1':(id=='fisik'?'b2':(id=='online'?'b3':(id=='urus'?'b4':'b5')))).classList.add('active');
        if(id=='fisik') realtimeLoad('registrations','tb_fisik','cnt_fisik');
        if(id=='online') realtimeLoad('online_registrations','tb_online','cnt_online');
        if(id=='urus') realtimeLoad('pengurusan','tb_urus','cnt_urus');
        if(id=='kritik') realtimeLoad('kritik_saran','tb_kritik','cnt_kritik');
    }

    // --- EDITOR HELPERS (BARU) ---
    window.fmt = function(id, cmd, val=null) {
        document.getElementById(id).focus();
        document.execCommand(cmd, false, val);
    }
    window.insImg = function(id) {
        const url = prompt("Masukkan Link Gambar (URL):");
        if(url) {
            document.getElementById(id).focus();
            document.execCommand('insertImage', false, url);
        }
    }

    // --- LOAD & SAVE SETTINGS ---
    const simpleFields = ['app_name','logo_url','header_bg','kop_1','kop_2','kop_3','kop_4','sch_pidum','sch_narkoba','sch_mon_am','sch_mon_pm','sch_fri','sch_sat','sch_sun','toko_announce','toko_link','wa_pengaduan','wa_channel','soc_ig','soc_fb','soc_tw','soc_yt'];
    const htmlFields = {'announcement': 'announcement_edit', 'txt_doc': 'txt_doc_edit', 'txt_item': 'txt_item_edit', 'txt_pb_cb': 'txt_pb_cb_edit'};

    function loadSettings() {
        db.ref('app_config').once('value', s => {
            if(s.exists()) {
                const d = s.val();
                simpleFields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = d[f]||""; });
                // Load HTML Content
                for(let key in htmlFields) {
                    if(document.getElementById(htmlFields[key])) document.getElementById(htmlFields[key]).innerHTML = d[key] || "";
                }
            }
        });
    }

    function saveConf() {
        const d = {};
        simpleFields.forEach(f => { if(document.getElementById(f)) d[f] = document.getElementById(f).value; });
        // Save HTML Content
        for(let key in htmlFields) {
            if(document.getElementById(htmlFields[key])) d[key] = document.getElementById(htmlFields[key]).innerHTML;
        }
        db.ref('app_config').update(d).then(() => alert("✅ Pengaturan Berhasil Disimpan!"));
    }

    // --- FUNGSI STANDAR (SAMA) ---
    function realtimeLoad(path, tbodyId, cntId) {
        const tb = document.getElementById(tbodyId);
        const cnt = document.getElementById(cntId);
        if(currentListener) db.ref().off();
        tb.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Memuat data...</td></tr>";
        cnt.innerText = "Connecting...";
        
        const ref = db.ref(path).limitToLast(500);
        currentListener = ref;
        
        ref.on('value', snapshot => { render(snapshot, tbodyId, path, cntId); });
    }

    function load(path, tbodyId, dateId) {
        const d = document.getElementById(dateId).value;
        if(!d) return alert("Pilih tanggal dulu!");
        if(currentListener) db.ref().off();
        document.getElementById(tbodyId).innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px;'>Mencari...</td></tr>";
        db.ref(path).orderByChild('tgl').equalTo(d).once('value').then(snap => { render(snap, tbodyId, path, null); });
    }

    function deleteAllData(path) {
        if(confirm("⚠️ HAPUS SEMUA DATA? Data tidak bisa dikembalikan!") && confirm("Yakin ingin melanjutkan?")) {
            db.ref(path).remove().then(() => alert("✅ Data bersih."));
        }
    }

    function render(snap, tbodyId, path, cntId) {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "";
        if(!snap.exists()) { 
            tb.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px; color:#999;'>Belum ada data.</td></tr>"; 
            if(cntId) document.getElementById(cntId).innerText = "Total: 0";
            return; 
        }

        const arr = [];
        snap.forEach(c => {
            const val = c.val();
            const key = c.key;
            DATA_CACHE[key] = val;
            arr.push({k:key, ...val});
        });
        
        if(cntId) document.getElementById(cntId).innerText = `Total: ${arr.length}`;

        arr.reverse().forEach(v => {
            try {
                let row = `<tr data-key="${v.k}">`;
                const btnAcc = `<button onclick="upd('${path}','${v.k}','accepted')" class="act-btn bg-acc"><i class="fas fa-check"></i></button>`;
                const btnRej = `<button onclick="upd('${path}','${v.k}','rejected')" class="act-btn bg-rej"><i class="fas fa-times"></i></button>`;
                const btnDel = `<button onclick="del('${path}','${v.k}')" class="act-btn bg-rej"><i class="fas fa-trash"></i></button>`;
                const actions = `<div style="display:flex; justify-content:center;">${btnAcc}${btnRej}${btnDel}</div>`;
                
                let statusBadge = v.status === 'accepted' ? '<span class="badge bg-acc">DISETUJUI</span>' : (v.status === 'rejected' ? '<span class="badge bg-rej">DITOLAK</span>' : '<span class="badge bg-wait">MENUNGGU</span>');
                const noteInput = `<input id="n-${v.k}" value="${v.note||''}" placeholder="Catatan..." onblur="saveNote('${path}','${v.k}',this.value)" style="font-size:11px; margin:0;">`;

                if(path === 'kritik_saran') {
                    row += `<td>${v.tgl}</td><td><b>${v.kepuasan}</b></td><td>${v.pesan}</td><td style="text-align:center">${btnDel}</td>`;
                } else if (path === 'pengurusan') {
                    let fileBtn = v.images ? `<button onclick='showFiles("${v.k}")' style="background:#17a2b8; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:10px;"><i class="fas fa-folder-open"></i> BERKAS</button>` : '-';
                    // UPDATE: Menambahkan NIK dan HP Penjamin
                    row += `<td>${v.tgl}</td><td>${v.jenis}</td><td><b>${v.wbp}</b></td><td><b>${v.penjamin}</b><br><small>NIK: ${v.nik}</small><br><small>HP: ${v.telp}</small></td><td>${v.hub}</td><td style="text-align:center">${fileBtn}</td><td style="text-align:center">${statusBadge}</td><td>${noteInput}</td><td>${actions}</td>`;
                } else {
                    let imgBtn = v.ktpUrl ? `<img src="${v.ktpUrl}" style="height:35px; border-radius:3px; cursor:pointer; border:1px solid #ccc;" onclick="showSingleImg('${v.k}')">` : '-';
                    // UPDATE: Menambahkan NIK dan HP Pengunjung
                    row += `<td style="font-weight:bold; color:#555; text-align:center;">${v.noAntrian||'-'}</td><td>${v.tgl}<br><small style="color:#666;">${v.jam||''}</small></td><td><b>${v.nama}</b><br><small>NIK: ${v.nik}</small><br><small>HP: ${v.telp}</small></td><td>${v.wbp}</td><td style="text-align:center">${imgBtn}</td><td style="text-align:center">${statusBadge}</td><td>${noteInput}</td><td>${actions}</td>`;
                }
                row += "</tr>";
                tb.insertAdjacentHTML('beforeend', row);
            } catch (e) { console.error(e); }
        });
    }

    function upd(path, key, st) { db.ref(path+'/'+key).update({status:st}); }
    function saveNote(path, key, val) { db.ref(path+'/'+key).update({note:val}); }
    function del(path, key) { if(confirm("Hapus data ini?")) { db.ref(path+'/'+key).remove(); } }

    window.showSingleImg = (key) => { const d = DATA_CACHE[key]; if(d && d.ktpUrl) { document.getElementById('imgView').src = d.ktpUrl; document.getElementById('imgModal').style.display = 'flex'; } }
    window.showFiles = (key) => {
        const d = DATA_CACHE[key]; const grid = document.getElementById('galleryGrid'); grid.innerHTML = '';
        if(d && d.images) {
            const labels = {'u_ktp_wbp': 'KTP WBP', 'u_kk_wbp': 'KK WBP', 'u_ktp_penj': 'KTP Penjamin', 'u_kk_penj': 'KK Penjamin', 'u_surat_1': 'Surat Pernyataan', 'u_surat_2': 'Surat Jaminan', 'u_foto': 'Foto Penjamin'};
            for(let k in d.images) {
                const div = document.createElement('div'); div.className = 'gallery-item';
                div.innerHTML = `<span style="font-size:10px; margin-bottom:5px;">${labels[k] || k}</span><img src="${d.images[k]}" onclick="document.getElementById('imgView').src=this.src; document.getElementById('imgModal').style.display='flex';">`;
                grid.appendChild(div);
            }
            document.getElementById('galleryModal').style.display='flex';
        }
    }
    window.closeM = (id) => document.getElementById(id).style.display='none';

    window.pdf = (tableId, title, nmId, nipId) => {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
        const petugas = document.getElementById(nmId).value; const nip = document.getElementById(nipId).value;
        if(!petugas) return alert("Mohon isi Nama Petugas!");

        const k1 = document.getElementById('kop_1').value.toUpperCase();
        const k2 = document.getElementById('kop_2').value.toUpperCase();
        const k3 = document.getElementById('kop_3').value.toUpperCase();
        const k4 = document.getElementById('kop_4').value;

        doc.setFont("times", "bold"); doc.setFontSize(14); doc.text(k1, 148, 15, {align:'center'});
        doc.text(k2, 148, 22, {align:'center'});
        doc.setFontSize(16); doc.text(k3, 148, 30, {align:'center'});
        doc.setFontSize(11); doc.setFont("times", "normal"); doc.text(k4, 148, 37, {align:'center'});
        doc.setLineWidth(0.5); doc.line(10, 42, 287, 42);

        doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.text(title.toUpperCase(), 148, 52, {align:'center'});
        doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("Dicetak Tanggal: " + new Date().toLocaleDateString('id-ID'), 148, 58, {align:'center'});

        const table = document.getElementById(tableId);
        
        // --- LOGIKA PDF BARU (KUSTOM) ---
        let headers = [];
        let body = [];
        
        // Tentukan Header dan Data berdasarkan ID Table
        if (tableId === 'tbl_fisik' || tableId === 'tbl_online') {
            headers = [['No', 'No Antrian', 'Waktu', 'Pengunjung', 'WBP', 'Status', 'Catatan']];
            Array.from(table.tBodies[0].rows).forEach((row, i) => {
                const cells = row.cells;
                const statusText = cells[5].innerText.trim();
                const noteVal = cells[6].querySelector('input') ? cells[6].querySelector('input').value : '';
                body.push([
                    i + 1, // Nomor
                    cells[0].innerText.trim(), // No Antrian
                    cells[1].innerText.trim(), // Waktu
                    cells[2].innerText.trim(), // Pengunjung (sudah ada nik/hp dari render)
                    cells[3].innerText.trim(), // WBP
                    statusText, // Status
                    noteVal // Catatan
                ]);
            });
        } else if (tableId === 'tbl_urus') {
            // FIX: Urutan Status & Catatan diperbaiki, Aksi dihapus
            headers = [['No', 'Tanggal', 'Jenis', 'WBP', 'Penjamin', 'Hubungan', 'Status', 'Catatan']];
            Array.from(table.tBodies[0].rows).forEach((row, i) => {
                const cells = row.cells;
                const statusText = cells[6].innerText.trim(); // Kolom 6 di HTML adalah Status
                const noteVal = cells[7].querySelector('input') ? cells[7].querySelector('input').value : ''; // Kolom 7 adalah Catatan
                body.push([
                    i + 1,
                    cells[0].innerText.trim(), // Tanggal
                    cells[1].innerText.trim(), // Jenis
                    cells[2].innerText.trim(), // WBP
                    cells[3].innerText.trim(), // Penjamin
                    cells[4].innerText.trim(), // Hubungan
                    statusText,
                    noteVal
                ]);
            });
        } else if (tableId === 'tbl_kritik') {
            headers = [['No', 'Tanggal', 'Kepuasan', 'Pesan / Masukan']];
            Array.from(table.tBodies[0].rows).forEach((row, i) => {
                const cells = row.cells;
                body.push([
                    i + 1,
                    cells[0].innerText.trim(),
                    cells[1].innerText.trim(),
                    cells[2].innerText.trim()
                ]);
            });
        }

        doc.autoTable({ head: headers, body: body, startY: 65, theme: 'grid', styles: { fontSize: 9, cellPadding: 3, valign: 'middle' }, headStyles: { fillColor: [85, 85, 85], textColor: 255, halign:'center' }, alternateRowStyles: { fillColor: [245, 245, 245] } });
        
        let finalY = doc.lastAutoTable.finalY + 20; if(finalY > 170) { doc.addPage(); finalY = 20; }
        const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
        doc.setFont("times", "normal"); doc.text(`Arga Makmur, ${dateStr}`, 230, finalY);
        doc.text("Petugas Layanan,", 230, finalY+6);
        doc.setFont("times", "bold"); doc.text(`( ${petugas} )`, 230, finalY+25);
        doc.setFont("times", "normal"); doc.text(`NIP. ${nip}`, 230, finalY+30);
        doc.save(title.replace(/\s+/g, '_') + ".pdf");
    }
</script>
</body>
</html>

