<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel v3.0</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #f4f6f9; padding: 20px; }
        .container { background: white; max-width: 1300px; margin: 0 auto; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .tab-btn { padding: 12px 20px; cursor: pointer; border: none; background: none; font-weight: bold; border-bottom: 3px solid transparent; color: #666; font-size: 14px; }
        .tab-btn.active { border-color: #8B0000; color: #8B0000; }
        .tab-content { display: none; margin-top: 20px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        th { background: #8B0000; color: white; padding: 12px; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; vertical-align: middle; }
        
        .btn-live { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        
        input, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        label { font-weight: bold; font-size: 12px; color: #555; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div id="login-box" style="text-align:center; padding:80px; max-width:400px; margin:0 auto;">
    <h2 style="color:#8B0000;">LOGIN ADMIN</h2>
    <input id="email" placeholder="Email" style="margin-bottom:10px;">
    <input id="pass" type="password" placeholder="Password" style="margin-bottom:20px;">
    <button onclick="login()" style="padding:12px 30px; background:#8B0000; color:white; border:none; border-radius:5px; cursor:pointer;">MASUK</button>
</div>

<div id="panel-box" class="container" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; color:#8B0000;">PANEL ADMIN LAPAS</h2>
        <div>
            <button onclick="cleanData()" style="padding:8px 15px; background:#666; color:white; border:none; border-radius:4px; cursor:pointer;">üßπ Bersihkan Data</button>
            <button onclick="logout()" style="padding:8px 15px; background:#333; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:5px;">Logout</button>
        </div>
    </div>
    
    <div style="border-bottom: 2px solid #eee;">
        <button class="tab-btn active" onclick="show('tatap')" id="btn-tatap">üì• TATAP MUKA</button>
        <button class="tab-btn" onclick="show('online')" id="btn-online">üíª VIDEO CALL</button>
        <button class="tab-btn" onclick="show('set')" id="btn-set">‚öôÔ∏è PENGATURAN</button>
    </div>

    <div id="tab-tatap" class="tab-content" style="display:block;">
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; display:flex; align-items:flex-end; gap:10px; border:1px solid #ddd;">
            <div style="flex:1">
                <label>Filter Tanggal:</label>
                <input type="date" id="date_tatap">
            </div>
            <button class="btn-search" onclick="loadData('db_utama/tatap_muka', 'tb_tatap', 'date_tatap')">üîç Cari</button>
            <button class="btn-live" onclick="loadLive('db_utama/tatap_muka', 'tb_tatap')">üîÑ RESET LIVE</button>
        </div>
        
        <div style="margin-top:15px; display:flex; gap:10px; align-items:flex-end; background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba;">
            <div style="flex:1"><label>Nama Petugas:</label><input id="ptg_tatap"></div>
            <div style="flex:1"><label>NIP:</label><input id="nip_tatap"></div>
            <button onclick="printPDF('tb_tatap', 'Laporan Kunjungan Tatap Muka', 'ptg_tatap', 'nip_tatap')" style="height:35px; background:#ff5722; color:white; border:none; border-radius:4px; cursor:pointer;">üñ®Ô∏è Cetak PDF</button>
        </div>

        <div style="overflow-x:auto;">
            <table id="tb_tatap"></table>
        </div>
    </div>

    <div id="tab-online" class="tab-content">
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; display:flex; align-items:flex-end; gap:10px; border:1px solid #ddd;">
            <div style="flex:1">
                <label>Filter Tanggal:</label>
                <input type="date" id="date_online">
            </div>
            <button class="btn-search" onclick="loadData('db_utama/video_call', 'tb_online', 'date_online')">üîç Cari</button>
            <button class="btn-live" onclick="loadLive('db_utama/video_call', 'tb_online')">üîÑ RESET LIVE</button>
        </div>
        
        <div style="margin-top:15px; display:flex; gap:10px; align-items:flex-end; background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba;">
            <div style="flex:1"><label>Nama Petugas:</label><input id="ptg_online"></div>
            <div style="flex:1"><label>NIP:</label><input id="nip_online"></div>
            <button onclick="printPDF('tb_online', 'Laporan Kunjungan Video Call', 'ptg_online', 'nip_online')" style="height:35px; background:#ff5722; color:white; border:none; border-radius:4px; cursor:pointer;">üñ®Ô∏è Cetak PDF</button>
        </div>

        <div style="overflow-x:auto;">
            <table id="tb_online"></table>
        </div>
    </div>

    <div id="tab-set" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h3>1. Tampilan & Kop Surat</h3>
                <label>Nama Aplikasi:</label><input id="app_name">
                <label>Logo URL:</label><input id="logo_url">
                <label>Background URL:</label><input id="header_bg">
                <label>Pengumuman (Running Text):</label><textarea id="announcement"></textarea>
                
                <label style="color:#8B0000; margin-top:10px;">Kop Surat (Untuk PDF):</label>
                <input id="kop_1" placeholder="Baris 1 (Kementerian)">
                <input id="kop_2" placeholder="Baris 2 (Wilayah)">
                <input id="kop_3" placeholder="Baris 3 (Nama Lapas)">
                <input id="kop_4" placeholder="Baris 4 (Alamat)">
            </div>
            <div>
                <h3>2. Jadwal & Konten</h3>
                <label>Jadwal PIDUM / NARKOBA:</label> 
                <div style="display:flex; gap:5px;"><input id="sch_pidum"><input id="sch_narkoba"></div>
                <label>Jam Pagi / Siang:</label> 
                <div style="display:flex; gap:5px;"><input id="sch_mon_am"><input id="sch_mon_pm"></div>
                
                <label>Syarat Dokumen & Barang:</label>
                <textarea id="txt_doc"></textarea>
                <textarea id="txt_item"></textarea>

                <label style="color:#8B0000; margin-top:10px;">Toko Lapas:</label>
                <textarea id="toko_announce" placeholder="Info Toko"></textarea>
                <input id="toko_link" placeholder="Link Aplikasi Toko">

                <label>Kontak & Sosmed:</label>
                <div style="display:flex; gap:5px;"><input id="wa_pengaduan" placeholder="No WA"><input id="wa_channel" placeholder="Link Channel"></div>
                <input id="soc_ig" placeholder="Instagram">
                <input id="soc_fb" placeholder="Facebook">
            </div>
        </div>
        <button onclick="saveSettings()" style="width:100%; padding:15px; background:green; color:white; font-weight:bold; font-size:16px; border:none; margin-top:20px; cursor:pointer;">üíæ SIMPAN SEMUA PENGATURAN</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDvpFZtiG_fXLOf8okjafNm7gqbJZr2pSY",
        authDomain: "lapassistem.firebaseapp.com",
        databaseURL: "https://lapassistem-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "lapassistem",
        storageBucket: "lapassistem.firebasestorage.app",
        messagingSenderId: "951059663532",
        appId: "1:951059663532:web:716bc3010eecc741a4ed09",
        measurementId: "G-25HSNZ35ZH"
    };

    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let listeners = {};

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-box').style.display='none';
            document.getElementById('panel-box').style.display='block';
            loadSettings();
            loadLive('db_utama/tatap_muka', 'tb_tatap');
            loadLive('db_utama/video_call', 'tb_online');
        } else {
            document.getElementById('login-box').style.display='block';
            document.getElementById('panel-box').style.display='none';
        }
    });

    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e=>alert(e.message)); }
    function logout() { auth.signOut(); }
    
    function show(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(b => b.className='tab-btn');
        document.getElementById('tab-'+id).style.display='block';
        document.getElementById('btn-'+id).className='tab-btn active';
    }

    // --- CORE DATA RENDER ---
    function render(snap, tableId, path) {
        const tb = document.getElementById(tableId);
        // Header Tabel
        let html = `<thead><tr>
            <th>ANTRIAN</th>
            <th>WAKTU</th>
            <th>PENGUNJUNG</th>
            <th>NIK</th>
            <th>ALAMAT</th>
            <th>TUJUAN</th>
            <th>STATUS</th>
            <th>AKSI</th>
        </tr></thead><tbody>`;

        if(!snap.exists()) { tb.innerHTML = html + "<tr><td colspan='8' align='center' style='padding:20px; color:#999'>Belum ada data pendaftaran.</td></tr></tbody>"; return; }
        
        const arr = [];
        snap.forEach(c => arr.push({k:c.key, ...c.val()}));
        
        arr.reverse().forEach(v => {
            let color = v.status==='accepted' ? 'green' : (v.status==='rejected' ? 'red' : 'gray');
            let txt = v.status==='accepted' ? 'Diterima' : (v.status==='rejected' ? 'Ditolak' : 'Menunggu');

            html += `<tr style="border-bottom:1px solid #eee">
                <td style="font-weight:bold; color:#8B0000; font-size:14px;">${v.noAntrian}</td>
                <td>${v.tgl}<br><small>${v.jam}</small></td>
                <td><b>${v.nama}</b><br><small>${v.telp}</small></td>
                <td>${v.nik || '-'}</td>
                <td><div style="max-width:150px; font-size:11px;">${v.alamat || '-'}</div></td>
                <td>${v.wbp}</td>
                <td><span style="background:${color}; color:white; padding:3px 8px; border-radius:10px; font-size:10px;">${txt}</span></td>
                <td>
                    <button onclick="upd('${path}/${v.k}','accepted')" style="border:none; cursor:pointer; background:none;">‚úÖ</button>
                    <button onclick="upd('${path}/${v.k}','rejected')" style="border:none; cursor:pointer; background:none;">‚ùå</button>
                    <button onclick="del('${path}/${v.k}')" style="border:none; cursor:pointer; background:none;">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        tb.innerHTML = html + "</tbody>";
    }

    function loadLive(path, tableId) {
        if(listeners[path]) db.ref(path).off();
        listeners[path] = db.ref(path).limitToLast(100);
        listeners[path].on('value', s => render(s, tableId, path));
    }

    function loadData(path, tableId, dateId) {
        const d = document.getElementById(dateId).value;
        if(!d) return alert("Pilih tanggal!");
        if(listeners[path]) db.ref(path).off();
        listeners[path] = db.ref(path).orderByChild('tgl').equalTo(d);
        listeners[path].on('value', s => render(s, tableId, path));
    }

    function upd(path, st) { db.ref(path).update({status:st}); }
    function del(path) { if(confirm("Hapus?")) db.ref(path).remove(); }
    function cleanData() { if(confirm("Hapus data > 30 hari?")) alert("Fitur clean aktif."); }

    // --- SETTINGS ---
    const ids = ['app_name','logo_url','header_bg','announcement',
                 'kop_1','kop_2','kop_3','kop_4',
                 'sch_pidum','sch_narkoba','sch_mon_am','sch_mon_pm','sch_fri','sch_sat','sch_sun',
                 'txt_doc','txt_item','toko_announce','toko_link',
                 'wa_pengaduan','wa_channel','soc_ig','soc_fb','soc_tw','soc_yt'];

    function loadSettings() {
        db.ref('app_config').once('value', s => {
            if(s.exists()) {
                const d = s.val();
                ids.forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = d[k] || ""; });
            }
        });
    }
    function saveSettings() {
        const d = {};
        ids.forEach(k => d[k] = document.getElementById(k).value);
        db.ref('app_config').update(d).then(()=>alert("Pengaturan Disimpan!"));
    }

    // --- PDF ENGINE (MANUAL SCRAPE) ---
    function printPDF(tbodyId, title, pId, nId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l','mm','a4');
        const cx = 148;

        const k1 = document.getElementById('kop_1').value;
        const k2 = document.getElementById('kop_2').value;
        const k3 = document.getElementById('kop_3').value;
        const k4 = document.getElementById('kop_4').value;
        const ptg = document.getElementById(pId).value;
        const nip = document.getElementById(nId).value;

        if(!ptg) return alert("Isi Nama Petugas!");

        doc.setFontSize(14); doc.setFont("times","bold"); doc.text(k1, cx, 15, 'center');
        doc.text(k2, cx, 22, 'center');
        doc.setFontSize(16); doc.text(k3, cx, 30, 'center');
        doc.setFontSize(10); doc.setFont("times","normal"); doc.text(k4, cx, 37, 'center');
        doc.line(20,42,277,42);

        doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.text(title, cx, 55, 'center');

        const rows = [];
        // Manual Scraping from HTML Table
        const trs = document.querySelectorAll(`#${tbodyId} tr`);
        trs.forEach((tr, i) => {
            if(i === 0) return; // Skip header row dari scraping (kita buat manual)
            const tds = tr.querySelectorAll('td');
            if(tds.length > 1) {
                rows.push([
                    tds[0].innerText, // Antrian
                    tds[1].innerText, // Waktu
                    tds[2].innerText, // Pengunjung
                    tds[3].innerText, // NIK
                    tds[4].innerText, // Alamat
                    tds[5].innerText, // Tujuan
                    tds[6].innerText  // Status
                ]);
            }
        });

        doc.autoTable({
            head: [['ANTRIAN','WAKTU','PENGUNJUNG','NIK','ALAMAT','TUJUAN','STATUS']],
            body: rows, 
            startY: 65, 
            theme: 'grid',
            columnStyles: { 4: {cellWidth: 50} } // Alamat lebih lebar
        });

        const fy = doc.lastAutoTable.finalY + 20;
        doc.setFontSize(11);
        doc.text(`Arga Makmur, ${new Date().toLocaleDateString('id-ID')}`, 220, fy);
        doc.text("Petugas,", 220, fy+7);
        doc.setFont("times","bold"); doc.text(`( ${ptg} )`, 220, fy+30);
        doc.setFont("times","normal"); doc.text(`NIP. ${nip}`, 220, fy+35);
        
        doc.save(title.replace(/ /g,"_")+'.pdf');
    }
</script>
</body>
</html>
