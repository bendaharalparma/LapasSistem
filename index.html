<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B0000">
    <title>Layanan Lapas Digital</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: #eef2f5; margin: 0; min-height: 100vh; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 480px; background: #fff; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: #8B0000; color: white; padding: 30px 20px; text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        .app-name { font-size: 18px; font-weight: bold; margin: 10px 0 0; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 16px; font-size: 13px; max-width: 90%; line-height: 1.5; }
        .bot { background: #f0f2f5; align-self: flex-start; border-top-left-radius: 4px; }
        .user { background: #ffebee; align-self: flex-end; border-top-right-radius: 4px; border: 1px solid #ffcdd2; color: #8B0000; }
        .btn { background: white; border: 1px solid #eee; padding: 14px; width: 100%; border-radius: 12px; font-weight: 600; font-size: 13px; color: #444; display: flex; justify-content: space-between; margin-bottom: 8px; cursor: pointer; }
        .btn:active { background: #f9f9f9; transform: scale(0.98); }
        .form-box { background: white; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #eee; margin-top: 5px; }
        .inp { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; font-size: 14px; }
        .submit-btn { background: #28a745; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 5px; cursor: pointer; }
        .ticket-card { border: 2px dashed #8B0000; padding: 20px; text-align: center; border-radius: 12px; margin-top: 10px; background: #fffcfc; }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <div style="background:white; width:60px; height:60px; border-radius:50%; margin:0 auto; padding:5px;"><img id="logo_img" src="" style="width:100%; height:100%; object-fit:contain;"></div>
        <div class="app-name" id="app_title">Loading...</div>
        <div style="font-size:11px; opacity:0.8;">Melayani Sepenuh Hati</div>
    </div>
    <div id="chat-box"></div>
</div>

<script>
    // --- ISI CONFIG FIREBASE ANDA ---
    const firebaseConfig = {
        apiKey: "AIzaSyDvpFZtiG_fXLOf8okjafNm7gqbJZr2pSY",
        authDomain: "lapassistem.firebaseapp.com",
        databaseURL: "https://lapassistem-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "lapassistem",
        storageBucket: "lapassistem.firebasestorage.app",
        messagingSenderId: "951059663532",
        appId: "1:951059663532:web:716bc3010eecc741a4ed09",
        measurementId: "G-25HSNZ35ZH"
    };

    window.addEventListener('load', () => {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let config = {};

        db.ref('app_config').on('value', snap => {
            if(snap.exists()) config = snap.val();
            document.getElementById('app_title').innerText = config.app_name || "Lapas App";
            document.getElementById('logo_img').src = config.logo_url || "";
            startChat();
        });

        const chatBox = document.getElementById('chat-box');
        window.startChat = function() { chatBox.innerHTML=''; appendMsg('bot', config.welcome_msg || "Halo, silakan pilih layanan:", {options: getMenu()}); }

        function appendMsg(sender, text, extra = {}) {
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            if(extra.customHtml) div.innerHTML += `<br>${extra.customHtml}`;
            
            if(extra.isForm) {
                div.innerHTML += `
                <div class="form-box">
                    <input id="f_nama" class="inp" placeholder="Nama Anda (Sesuai KTP)">
                    <input id="f_nik" class="inp" type="number" placeholder="NIK (Wajib Diisi)">
                    <input id="f_alamat" class="inp" placeholder="Alamat Lengkap">
                    <input id="f_telp" class="inp" type="tel" placeholder="Nomor HP / WA">
                    <input id="f_wbp" class="inp" placeholder="Nama WBP (Tujuan)">
                    <label style="font-size:12px; font-weight:bold;">Pilih Tanggal & Sesi:</label>
                    <div style="display:flex; gap:5px;">
                        <input id="f_tgl" class="inp" type="date" style="flex:2">
                        <select id="f_jam" class="inp" style="flex:1">
                            <option value="Pagi">Pagi</option>
                            <option value="Siang">Siang</option>
                        </select>
                    </div>
                    <button onclick="submitForm('${extra.type}')" class="submit-btn">AMBIL ANTRIAN</button>
                    <button onclick="startChat()" style="background:#eee; color:#333; padding:10px; border:none; width:100%; border-radius:8px; margin-top:5px;">Batal</button>
                </div>`;
            }
            chatBox.appendChild(div);
            if(extra.options) showBtn(extra.options);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showBtn(opts) {
            const div = document.createElement('div');
            opts.forEach(o => {
                const btn = document.createElement('div');
                btn.className = 'btn';
                btn.innerHTML = `<span>${o.text}</span> <i class="fas fa-chevron-right"></i>`;
                btn.onclick = () => {
                    div.remove();
                    appendMsg('user', o.text);
                    if(o.val === 'form_fisik') appendMsg('bot', "üìù **FORMULIR TATAP MUKA**", {isForm:true, type:'tatap_muka'});
                    else if(o.val === 'form_online') appendMsg('bot', "üíª **FORMULIR VIDEO CALL**", {isForm:true, type:'video_call'});
                    else if(o.val === 'jadwal') appendMsg('bot', "üìÖ **JADWAL:**\nPIDUM: Senin & Rabu\nNARKOBA: Selasa & Kamis", {options:[{text:"‚¨ÖÔ∏è KEMBALI", val:"start"}]});
                    else startChat();
                };
                div.appendChild(btn);
            });
            chatBox.appendChild(div);
        }

        window.submitForm = function(type) {
            const nama = document.getElementById('f_nama').value;
            const nik = document.getElementById('f_nik').value;
            const alamat = document.getElementById('f_alamat').value;
            const telp = document.getElementById('f_telp').value;
            const wbp = document.getElementById('f_wbp').value;
            const tgl = document.getElementById('f_tgl').value;
            const jam = document.getElementById('f_jam').value;

            if(!nama || !nik || !tgl) return alert("Nama, NIK, dan Tanggal Wajib Diisi!");

            const btn = document.querySelector('.submit-btn');
            btn.innerText = "Memproses..."; btn.disabled = true;

            // JALUR BARU: counters_v2 & db_utama
            const counterPath = `counters_v2/${tgl}/${type}/${jam}`;
            const dbPath = `db_utama/${type}`;
            const prefix = type === 'tatap_muka' ? 'A' : 'V';
            const code = jam === 'Pagi' ? 'P' : 'S';

            db.ref(counterPath).transaction(c => (c || 0) + 1, (err, committed, snap) => {
                if(committed) {
                    const noAntrian = `${prefix}-${code}-${String(snap.val()).padStart(3, '0')}`;
                    db.ref(dbPath).push({
                        nama, nik, alamat, telp, wbp, tgl, jam, noAntrian,
                        status: 'waiting', createdAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        chatBox.innerHTML = '';
                        const tiket = `<div class="ticket-card"><h3>ANTRIAN ${type.toUpperCase().replace('_',' ')}</h3><h1>${noAntrian}</h1><p>${nama}<br>${tgl} (${jam})</p><button onclick="window.print()" style="padding:5px 10px;">Simpan Bukti</button></div>`;
                        appendMsg('bot', "‚úÖ **BERHASIL!**", {customHtml: tiket, options:[{text:"‚¨ÖÔ∏è MENU UTAMA", val:"start"}]});
                    });
                } else {
                    btn.innerText = "Coba Lagi"; btn.disabled = false;
                    alert("Gagal koneksi database.");
                }
            });
        }

        function getMenu() {
            return [
                {text:"üìù DAFTAR TATAP MUKA", val:"form_fisik"},
                {text:"üíª DAFTAR VIDEO CALL", val:"form_online"},
                {text:"üìÖ LIHAT JADWAL", val:"jadwal"}
            ];
        }
    });
</script>
</body>
</html>
